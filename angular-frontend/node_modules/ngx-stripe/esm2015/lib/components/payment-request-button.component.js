import { __awaiter } from "tslib";
import { Component, Input, ViewChild, EventEmitter, Output } from '@angular/core';
import { from } from 'rxjs';
import { StripeElementsService } from '../services/stripe-elements.service';
export class StripePaymentRequestButtonComponent {
    constructor(stripeElementsService) {
        this.stripeElementsService = stripeElementsService;
        this.load = new EventEmitter();
        this.change = new EventEmitter();
        this.blur = new EventEmitter();
        this.focus = new EventEmitter();
        this.ready = new EventEmitter();
        this.token = new EventEmitter();
        this.paymentMethod = new EventEmitter();
        this.source = new EventEmitter();
        this.cancel = new EventEmitter();
        this.shippingaddresschange = new EventEmitter();
        this.shippingoptionchange = new EventEmitter();
        this.notavailable = new EventEmitter();
    }
    ngOnChanges(changes) {
        return __awaiter(this, void 0, void 0, function* () {
            const options = this.stripeElementsService.mergeOptions(this.options, this.containerClass);
            const elementsOptions = this.elementsOptions;
            const stripe = this.stripe;
            let updateElements = false;
            if (changes.elementsOptions || changes.stripe || !this.elements) {
                const elements = yield this.stripeElementsService
                    .elements(stripe, elementsOptions)
                    .toPromise();
                this.elements = elements;
                updateElements = true;
            }
            if (changes.paymentOptions && this.paymentRequest) {
                this.updateRequest(this.paymentOptions);
            }
            if (changes.options ||
                changes.containerClass ||
                !this.element ||
                updateElements) {
                if (this.element && !updateElements) {
                    this.update(options);
                }
                else if (this.elements && updateElements) {
                    this.paymentRequest = this.stripeElementsService.paymentRequest(stripe, this.paymentOptions);
                    this.paymentRequest.on('token', (ev) => this.token.emit(ev));
                    this.paymentRequest.on('paymentmethod', (ev) => this.paymentMethod.emit(ev));
                    this.paymentRequest.on('source', (ev) => this.source.emit(ev));
                    this.paymentRequest.on('cancel', () => this.cancel.emit());
                    this.paymentRequest.on('shippingaddresschange', (ev) => this.shippingaddresschange.emit(ev));
                    this.paymentRequest.on('shippingoptionchange', (ev) => this.shippingoptionchange.emit(ev));
                    this.element = this.elements.create('paymentRequestButton', Object.assign({ paymentRequest: this.paymentRequest }, options));
                    this.canMakePayment().subscribe((result) => {
                        if (result) {
                            this.element.on('click', (ev) => this.change.emit(ev));
                            this.element.on('blur', () => this.blur.emit());
                            this.element.on('focus', () => this.focus.emit());
                            this.element.on('ready', () => this.ready.emit());
                            this.element.mount(this.stripeElementRef.nativeElement);
                            this.load.emit({
                                paymentRequestButton: this.element,
                                paymentRequest: this.paymentRequest
                            });
                        }
                        else {
                            this.notavailable.emit();
                        }
                    });
                }
            }
        });
    }
    canMakePayment() {
        return from(this.paymentRequest.canMakePayment());
    }
    update(options) {
        this.element.update(options);
    }
    updateRequest(options) {
        this.paymentRequest.update(options);
    }
    show() {
        this.paymentRequest.show();
    }
    /**
     * @deprecated
     */
    getButton() {
        return this.element;
    }
}
StripePaymentRequestButtonComponent.decorators = [
    { type: Component, args: [{
                selector: 'ngx-stripe-payment-request-button',
                template: `<div class="field" #stripeElementRef></div>`
            },] }
];
StripePaymentRequestButtonComponent.ctorParameters = () => [
    { type: StripeElementsService }
];
StripePaymentRequestButtonComponent.propDecorators = {
    stripeElementRef: [{ type: ViewChild, args: ['stripeElementRef',] }],
    containerClass: [{ type: Input }],
    paymentOptions: [{ type: Input }],
    options: [{ type: Input }],
    elementsOptions: [{ type: Input }],
    stripe: [{ type: Input }],
    load: [{ type: Output }],
    change: [{ type: Output }],
    blur: [{ type: Output }],
    focus: [{ type: Output }],
    ready: [{ type: Output }],
    token: [{ type: Output }],
    paymentMethod: [{ type: Output }],
    source: [{ type: Output }],
    cancel: [{ type: Output }],
    shippingaddresschange: [{ type: Output }],
    shippingoptionchange: [{ type: Output }],
    notavailable: [{ type: Output }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGF5bWVudC1yZXF1ZXN0LWJ1dHRvbi5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtc3RyaXBlL3NyYy9saWIvY29tcG9uZW50cy9wYXltZW50LXJlcXVlc3QtYnV0dG9uLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxLQUFLLEVBQ0wsU0FBUyxFQUVULFlBQVksRUFDWixNQUFNLEVBR1AsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFjLElBQUksRUFBRSxNQUFNLE1BQU0sQ0FBQztBQW9CeEMsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFNNUUsTUFBTSxPQUFPLG1DQUFtQztJQXVDOUMsWUFBbUIscUJBQTRDO1FBQTVDLDBCQUFxQixHQUFyQixxQkFBcUIsQ0FBdUI7UUE1QnJELFNBQUksR0FBRyxJQUFJLFlBQVksRUFHN0IsQ0FBQztRQUVLLFdBQU0sR0FBRyxJQUFJLFlBQVksRUFFaEMsQ0FBQztRQUNNLFNBQUksR0FBRyxJQUFJLFlBQVksRUFBUSxDQUFDO1FBQ2hDLFVBQUssR0FBRyxJQUFJLFlBQVksRUFBUSxDQUFDO1FBQ2pDLFVBQUssR0FBRyxJQUFJLFlBQVksRUFBUSxDQUFDO1FBRWpDLFVBQUssR0FBRyxJQUFJLFlBQVksRUFBNEIsQ0FBQztRQUNyRCxrQkFBYSxHQUFHLElBQUksWUFBWSxFQUV2QyxDQUFDO1FBQ00sV0FBTSxHQUFHLElBQUksWUFBWSxFQUE2QixDQUFDO1FBQ3ZELFdBQU0sR0FBRyxJQUFJLFlBQVksRUFBUSxDQUFDO1FBQ2xDLDBCQUFxQixHQUFHLElBQUksWUFBWSxFQUUvQyxDQUFDO1FBQ00seUJBQW9CLEdBQUcsSUFBSSxZQUFZLEVBRTlDLENBQUM7UUFDTSxpQkFBWSxHQUFHLElBQUksWUFBWSxFQUFRLENBQUM7SUFJZ0IsQ0FBQztJQUU3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Q0FBQyxDQUFDO0lBQy9CLENBQUM7SUFFRCxhQUFhLENBQUMsT0FBb0M7UUFDaEQsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDdEMsQ0FBQztJQUVELElBQUk7UUFDRixJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxDQUFDO0lBQzdCLENBQUM7SUFFRDs7T0FFRztJQUNILFNBQVM7UUFDUCxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUM7SUFDdEIsQ0FBQzs7O1lBMUlGLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsbUNBQW1DO2dCQUM3QyxRQUFRLEVBQUUsNkNBQTZDO2FBQ3hEOzs7WUFMUSxxQkFBcUI7OzsrQkFPM0IsU0FBUyxTQUFDLGtCQUFrQjs2QkFJNUIsS0FBSzs2QkFDTCxLQUFLO3NCQUNMLEtBQUs7OEJBQ0wsS0FBSztxQkFDTCxLQUFLO21CQUVMLE1BQU07cUJBS04sTUFBTTttQkFHTixNQUFNO29CQUNOLE1BQU07b0JBQ04sTUFBTTtvQkFFTixNQUFNOzRCQUNOLE1BQU07cUJBR04sTUFBTTtxQkFDTixNQUFNO29DQUNOLE1BQU07bUNBR04sTUFBTTsyQkFHTixNQUFNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29tcG9uZW50LFxuICBJbnB1dCxcbiAgVmlld0NoaWxkLFxuICBFbGVtZW50UmVmLFxuICBFdmVudEVtaXR0ZXIsXG4gIE91dHB1dCxcbiAgT25DaGFuZ2VzLFxuICBTaW1wbGVDaGFuZ2VzXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgZnJvbSB9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQge1xuICBTdHJpcGVFbGVtZW50c09wdGlvbnMsXG4gIFN0cmlwZUVsZW1lbnRzLFxuICBQYXltZW50UmVxdWVzdE9wdGlvbnMsXG4gIFBheW1lbnRSZXF1ZXN0LFxuICBDYW5NYWtlUGF5bWVudFJlc3VsdCxcbiAgUGF5bWVudFJlcXVlc3RVcGRhdGVPcHRpb25zLFxuICBTdHJpcGVQYXltZW50UmVxdWVzdEJ1dHRvbkVsZW1lbnQsXG4gIFN0cmlwZVBheW1lbnRSZXF1ZXN0QnV0dG9uRWxlbWVudE9wdGlvbnMsXG4gIFN0cmlwZVBheW1lbnRSZXF1ZXN0QnV0dG9uRWxlbWVudENsaWNrRXZlbnQsXG4gIFBheW1lbnRSZXF1ZXN0VG9rZW5FdmVudCxcbiAgUGF5bWVudFJlcXVlc3RQYXltZW50TWV0aG9kRXZlbnQsXG4gIFBheW1lbnRSZXF1ZXN0U291cmNlRXZlbnQsXG4gIFBheW1lbnRSZXF1ZXN0U2hpcHBpbmdBZGRyZXNzRXZlbnQsXG4gIFBheW1lbnRSZXF1ZXN0U2hpcHBpbmdPcHRpb25FdmVudFxufSBmcm9tICdAc3RyaXBlL3N0cmlwZS1qcyc7XG5cbmltcG9ydCB7IFN0cmlwZUluc3RhbmNlIH0gZnJvbSAnLi4vc2VydmljZXMvc3RyaXBlLWluc3RhbmNlLmNsYXNzJztcbmltcG9ydCB7IFN0cmlwZUVsZW1lbnRzU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL3N0cmlwZS1lbGVtZW50cy5zZXJ2aWNlJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnbmd4LXN0cmlwZS1wYXltZW50LXJlcXVlc3QtYnV0dG9uJyxcbiAgdGVtcGxhdGU6IGA8ZGl2IGNsYXNzPVwiZmllbGRcIiAjc3RyaXBlRWxlbWVudFJlZj48L2Rpdj5gXG59KVxuZXhwb3J0IGNsYXNzIFN0cmlwZVBheW1lbnRSZXF1ZXN0QnV0dG9uQ29tcG9uZW50IGltcGxlbWVudHMgT25DaGFuZ2VzIHtcbiAgQFZpZXdDaGlsZCgnc3RyaXBlRWxlbWVudFJlZicpIHB1YmxpYyBzdHJpcGVFbGVtZW50UmVmITogRWxlbWVudFJlZjtcbiAgZWxlbWVudCE6IFN0cmlwZVBheW1lbnRSZXF1ZXN0QnV0dG9uRWxlbWVudDtcbiAgcGF5bWVudFJlcXVlc3QhOiBQYXltZW50UmVxdWVzdDtcblxuICBASW5wdXQoKSBjb250YWluZXJDbGFzczogc3RyaW5nO1xuICBASW5wdXQoKSBwYXltZW50T3B0aW9uczogUGF5bWVudFJlcXVlc3RPcHRpb25zO1xuICBASW5wdXQoKSBvcHRpb25zOiBTdHJpcGVQYXltZW50UmVxdWVzdEJ1dHRvbkVsZW1lbnRPcHRpb25zO1xuICBASW5wdXQoKSBlbGVtZW50c09wdGlvbnM6IFBhcnRpYWw8U3RyaXBlRWxlbWVudHNPcHRpb25zPjtcbiAgQElucHV0KCkgc3RyaXBlOiBTdHJpcGVJbnN0YW5jZTtcblxuICBAT3V0cHV0KCkgbG9hZCA9IG5ldyBFdmVudEVtaXR0ZXI8e1xuICAgIHBheW1lbnRSZXF1ZXN0QnV0dG9uOiBTdHJpcGVQYXltZW50UmVxdWVzdEJ1dHRvbkVsZW1lbnQ7XG4gICAgcGF5bWVudFJlcXVlc3Q6IFBheW1lbnRSZXF1ZXN0O1xuICB9PigpO1xuXG4gIEBPdXRwdXQoKSBjaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyPFxuICAgIFN0cmlwZVBheW1lbnRSZXF1ZXN0QnV0dG9uRWxlbWVudENsaWNrRXZlbnRcbiAgPigpO1xuICBAT3V0cHV0KCkgYmx1ciA9IG5ldyBFdmVudEVtaXR0ZXI8dm9pZD4oKTtcbiAgQE91dHB1dCgpIGZvY3VzID0gbmV3IEV2ZW50RW1pdHRlcjx2b2lkPigpO1xuICBAT3V0cHV0KCkgcmVhZHkgPSBuZXcgRXZlbnRFbWl0dGVyPHZvaWQ+KCk7XG5cbiAgQE91dHB1dCgpIHRva2VuID0gbmV3IEV2ZW50RW1pdHRlcjxQYXltZW50UmVxdWVzdFRva2VuRXZlbnQ+KCk7XG4gIEBPdXRwdXQoKSBwYXltZW50TWV0aG9kID0gbmV3IEV2ZW50RW1pdHRlcjxcbiAgICBQYXltZW50UmVxdWVzdFBheW1lbnRNZXRob2RFdmVudFxuICA+KCk7XG4gIEBPdXRwdXQoKSBzb3VyY2UgPSBuZXcgRXZlbnRFbWl0dGVyPFBheW1lbnRSZXF1ZXN0U291cmNlRXZlbnQ+KCk7XG4gIEBPdXRwdXQoKSBjYW5jZWwgPSBuZXcgRXZlbnRFbWl0dGVyPHZvaWQ+KCk7XG4gIEBPdXRwdXQoKSBzaGlwcGluZ2FkZHJlc3NjaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyPFxuICAgIFBheW1lbnRSZXF1ZXN0U2hpcHBpbmdBZGRyZXNzRXZlbnRcbiAgPigpO1xuICBAT3V0cHV0KCkgc2hpcHBpbmdvcHRpb25jaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyPFxuICAgIFBheW1lbnRSZXF1ZXN0U2hpcHBpbmdPcHRpb25FdmVudFxuICA+KCk7XG4gIEBPdXRwdXQoKSBub3RhdmFpbGFibGUgPSBuZXcgRXZlbnRFbWl0dGVyPHZvaWQ+KCk7XG5cbiAgZWxlbWVudHM6IFN0cmlwZUVsZW1lbnRzO1xuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBzdHJpcGVFbGVtZW50c1NlcnZpY2U6IFN0cmlwZUVsZW1lbnRzU2VydmljZSkge31cblxuICBhc3luYyBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHRoaXMuc3RyaXBlRWxlbWVudHNTZXJ2aWNlLm1lcmdlT3B0aW9ucyhcbiAgICAgIHRoaXMub3B0aW9ucyxcbiAgICAgIHRoaXMuY29udGFpbmVyQ2xhc3NcbiAgICApO1xuICAgIGNvbnN0IGVsZW1lbnRzT3B0aW9ucyA9IHRoaXMuZWxlbWVudHNPcHRpb25zO1xuICAgIGNvbnN0IHN0cmlwZSA9IHRoaXMuc3RyaXBlO1xuICAgIGxldCB1cGRhdGVFbGVtZW50cyA9IGZhbHNlO1xuXG4gICAgaWYgKGNoYW5nZXMuZWxlbWVudHNPcHRpb25zIHx8IGNoYW5nZXMuc3RyaXBlIHx8ICF0aGlzLmVsZW1lbnRzKSB7XG4gICAgICBjb25zdCBlbGVtZW50cyA9IGF3YWl0IHRoaXMuc3RyaXBlRWxlbWVudHNTZXJ2aWNlXG4gICAgICAgIC5lbGVtZW50cyhzdHJpcGUsIGVsZW1lbnRzT3B0aW9ucylcbiAgICAgICAgLnRvUHJvbWlzZSgpO1xuICAgICAgdGhpcy5lbGVtZW50cyA9IGVsZW1lbnRzO1xuICAgICAgdXBkYXRlRWxlbWVudHMgPSB0cnVlO1xuICAgIH1cblxuICAgIGlmIChjaGFuZ2VzLnBheW1lbnRPcHRpb25zICYmIHRoaXMucGF5bWVudFJlcXVlc3QpIHtcbiAgICAgIHRoaXMudXBkYXRlUmVxdWVzdCh0aGlzLnBheW1lbnRPcHRpb25zKTtcbiAgICB9XG5cbiAgICBpZiAoXG4gICAgICBjaGFuZ2VzLm9wdGlvbnMgfHxcbiAgICAgIGNoYW5nZXMuY29udGFpbmVyQ2xhc3MgfHxcbiAgICAgICF0aGlzLmVsZW1lbnQgfHxcbiAgICAgIHVwZGF0ZUVsZW1lbnRzXG4gICAgKSB7XG4gICAgICBpZiAodGhpcy5lbGVtZW50ICYmICF1cGRhdGVFbGVtZW50cykge1xuICAgICAgICB0aGlzLnVwZGF0ZShvcHRpb25zKTtcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5lbGVtZW50cyAmJiB1cGRhdGVFbGVtZW50cykge1xuICAgICAgICB0aGlzLnBheW1lbnRSZXF1ZXN0ID0gdGhpcy5zdHJpcGVFbGVtZW50c1NlcnZpY2UucGF5bWVudFJlcXVlc3QoXG4gICAgICAgICAgc3RyaXBlLFxuICAgICAgICAgIHRoaXMucGF5bWVudE9wdGlvbnNcbiAgICAgICAgKTtcbiAgICAgICAgdGhpcy5wYXltZW50UmVxdWVzdC5vbigndG9rZW4nLCAoZXYpID0+IHRoaXMudG9rZW4uZW1pdChldikpO1xuICAgICAgICB0aGlzLnBheW1lbnRSZXF1ZXN0Lm9uKCdwYXltZW50bWV0aG9kJywgKGV2KSA9PlxuICAgICAgICAgIHRoaXMucGF5bWVudE1ldGhvZC5lbWl0KGV2KVxuICAgICAgICApO1xuICAgICAgICB0aGlzLnBheW1lbnRSZXF1ZXN0Lm9uKCdzb3VyY2UnLCAoZXYpID0+IHRoaXMuc291cmNlLmVtaXQoZXYpKTtcbiAgICAgICAgdGhpcy5wYXltZW50UmVxdWVzdC5vbignY2FuY2VsJywgKCkgPT4gdGhpcy5jYW5jZWwuZW1pdCgpKTtcbiAgICAgICAgdGhpcy5wYXltZW50UmVxdWVzdC5vbignc2hpcHBpbmdhZGRyZXNzY2hhbmdlJywgKGV2KSA9PlxuICAgICAgICAgIHRoaXMuc2hpcHBpbmdhZGRyZXNzY2hhbmdlLmVtaXQoZXYpXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMucGF5bWVudFJlcXVlc3Qub24oJ3NoaXBwaW5nb3B0aW9uY2hhbmdlJywgKGV2KSA9PlxuICAgICAgICAgIHRoaXMuc2hpcHBpbmdvcHRpb25jaGFuZ2UuZW1pdChldilcbiAgICAgICAgKTtcbiAgICAgICAgdGhpcy5lbGVtZW50ID0gdGhpcy5lbGVtZW50cy5jcmVhdGUoJ3BheW1lbnRSZXF1ZXN0QnV0dG9uJywge1xuICAgICAgICAgIHBheW1lbnRSZXF1ZXN0OiB0aGlzLnBheW1lbnRSZXF1ZXN0LFxuICAgICAgICAgIC4uLm9wdGlvbnNcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5jYW5NYWtlUGF5bWVudCgpLnN1YnNjcmliZSgocmVzdWx0KSA9PiB7XG4gICAgICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICAgICAgdGhpcy5lbGVtZW50Lm9uKCdjbGljaycsIChldikgPT4gdGhpcy5jaGFuZ2UuZW1pdChldikpO1xuICAgICAgICAgICAgdGhpcy5lbGVtZW50Lm9uKCdibHVyJywgKCkgPT4gdGhpcy5ibHVyLmVtaXQoKSk7XG4gICAgICAgICAgICB0aGlzLmVsZW1lbnQub24oJ2ZvY3VzJywgKCkgPT4gdGhpcy5mb2N1cy5lbWl0KCkpO1xuICAgICAgICAgICAgdGhpcy5lbGVtZW50Lm9uKCdyZWFkeScsICgpID0+IHRoaXMucmVhZHkuZW1pdCgpKTtcblxuICAgICAgICAgICAgdGhpcy5lbGVtZW50Lm1vdW50KHRoaXMuc3RyaXBlRWxlbWVudFJlZi5uYXRpdmVFbGVtZW50KTtcblxuICAgICAgICAgICAgdGhpcy5sb2FkLmVtaXQoe1xuICAgICAgICAgICAgICBwYXltZW50UmVxdWVzdEJ1dHRvbjogdGhpcy5lbGVtZW50LFxuICAgICAgICAgICAgICBwYXltZW50UmVxdWVzdDogdGhpcy5wYXltZW50UmVxdWVzdFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMubm90YXZhaWxhYmxlLmVtaXQoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGNhbk1ha2VQYXltZW50KCk6IE9ic2VydmFibGU8Q2FuTWFrZVBheW1lbnRSZXN1bHQgfCBudWxsPiB7XG4gICAgcmV0dXJuIGZyb20odGhpcy5wYXltZW50UmVxdWVzdC5jYW5NYWtlUGF5bWVudCgpKTtcbiAgfVxuXG4gIHVwZGF0ZShvcHRpb25zOiBQYXJ0aWFsPFN0cmlwZVBheW1lbnRSZXF1ZXN0QnV0dG9uRWxlbWVudE9wdGlvbnM+KSB7XG4gICAgdGhpcy5lbGVtZW50LnVwZGF0ZShvcHRpb25zKTtcbiAgfVxuXG4gIHVwZGF0ZVJlcXVlc3Qob3B0aW9uczogUGF5bWVudFJlcXVlc3RVcGRhdGVPcHRpb25zKSB7XG4gICAgdGhpcy5wYXltZW50UmVxdWVzdC51cGRhdGUob3B0aW9ucyk7XG4gIH1cblxuICBzaG93KCkge1xuICAgIHRoaXMucGF5bWVudFJlcXVlc3Quc2hvdygpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBkZXByZWNhdGVkXG4gICAqL1xuICBnZXRCdXR0b24oKSB7XG4gICAgcmV0dXJuIHRoaXMuZWxlbWVudDtcbiAgfVxufVxuIl19